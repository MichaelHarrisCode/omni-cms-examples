var savedPresets=[{name:"2 Images",sizes:[{width:1200,suffix:"-lg"},{width:400,suffix:"-sm"}]},{name:"3 Images",sizes:[{width:1200,suffix:"-lg"},{width:600,suffix:"-md"},{width:400,suffix:"-sm"}]},{name:"4 Images",sizes:[{width:1600,suffix:"-xl"},{width:1200,suffix:"-lg"},{width:600,suffix:"-md"},{width:400,suffix:"-sm"}]}],gadget=gadget||!1,myGadget=myGadget||!1,imagesets=[],imagesSelected=0,imagesLoaded=0,imagesProcessed=0,existingImages=[],metadata_mime_type="image-resizer-gadget",presets=[];function messageUser(e,t,a){void 0===t&&(t="warning"),void 0===a&&(a=0),"success"==t?($("#user-message").removeClass("alert-warning").addClass("alert-success"),$("#user-message span.glyphicon").removeClass("glyphicon-exclamation-sign").addClass("glyphicon-ok")):($("#user-message").removeClass("alert-success").addClass("alert-warning"),$("#user-message span.glyphicon").removeClass("glyphicon-ok").addClass("glyphicon-exclamation-sign")),$("#user-message .message").text(e),$("#user-message").addClass("slide-up"),a>0&&setTimeout(hideUserMessage,a)}function hideUserMessage(){$("#user-message").removeClass("slide-up")}function finished(){messageUser("All images have been processed.","success",5e3)}function renderPresetList(){$("#list-card ul li").remove();for(var e=presets.length,t=0;t<e;t++){var a={name:presets[t].name,id:t};$("#list-card ul").append(compileTemplate($("#list-preset-template").html(),a))}switchDisplay("list-card")}function savePresets(){var e=function(){savedPresets=presets,renderPresetDropdown(),$("#preset-dropdown").trigger("change"),switchDisplay("main")};gadget.Metadata.list({mime_type:metadata_mime_type},{success:function(t){if(t.length){var a=t[0].id;gadget.Metadata.update({mime_type:metadata_mime_type,id:a,action:"update",scope:"public",metadata:JSON.stringify(presets)},{success:function(){messageUser("Presets Saved!","success",3e3),e()}})}else gadget.Metadata.create({mime_type:metadata_mime_type,scope:"public",metadata:JSON.stringify(presets)},{success:function(){messageUser("Presets Saved!","success",3e3),e()}})}})}function switchDisplay(e){$(".screen").hide(),$("#"+e).show(),window.scrollTo(0,0)}function loadPreset(e){if(clearPresetForm(),switchDisplay("form-card"),void 0!==e){var t=presets[e];$("#form-card .card-header").text("Edit Preset"),$("#presetName").val(t.name),$('[name="presetID"]').val(e),$.each(t.sizes,function(e,t){addPresetRow(t.width,t.suffix)})}addPresetRow()}function deletePreset(e){presets.length>1?(presets.splice(e,1),renderPresetList()):messageUser("You must keep at least one preset!","warning",3e3)}function renderPresetDropdown(){$("#preset-dropdown option:not(:first)").remove();for(var e=savedPresets.length,t=0;t<e;t++)$("#preset-dropdown").append('<option value="'+t+'">'+savedPresets[t].name+"</option>")}function addPresetRow(e,t){var a={width:e||"",suffix:t||""};$('#manage-presets button[type="submit"]').before(compileTemplate($("#preset-row-template").html(),a))}function compileTemplate(e,t){for(var a in t)e=e.replace(new RegExp("{{"+a+"}}","g"),t[a]);return e}function clearPresetForm(){$(".form-group.row").remove(),$(".invalid").valid(),$("#form-card .card-header").text("Add Preset"),$('#manage-presets [name="presetID"]').val(""),$("#presetName").val("")}function trim(e){return e.replace(/^\s+|\s+$/g,"")}function isInteger(e){return/^[1-9]\d*$/.test(e)}function scrollToMiddle(e){e.offset().top;var t,a=e.offset().top,s=e.height(),i=$(window).height();t=s<i?a-(i/2-s/2):a,$("html, body").animate({scrollTop:t},700)}function ImageSet(e,t){var a={"image/jpeg":"jpg","image/png":"png","image/webp":"webp"},s=function(e){("number"!=typeof e||e<1)&&(e=10);for(var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",a="",s=0;s<e;s++){a+=t[Math.floor(Math.random()*t.length)]}return a};if(!(e instanceof HTMLImageElement))throw"The source must be an HTMLImageElement.";if(!e.complete)throw"Please call the ImageSet constructor after the image has been loaded.";var i={elementId:"main",name:s(12),fullname:s(12),sizes:[{width:1920,suffix:"-xl"},{width:1280,suffix:"-lg"},{width:800,suffix:"-md"},{width:600,suffix:"-sm"},{width:480,suffix:"-xs"}]};null!=t&&"object"==typeof t||(t=i);var n=this;this.output={elementId:t.elementId||i.elementId,type:"image/jpeg",name:t.name||i.name,fullname:t.fullname||i.fullname},this.source={image:e,width:e.naturalWidth,height:e.naturalHeight},this.sizes=t.sizes||i.sizes,this.sizes.sort(function(e,t){return t.width-e.width}),this.resize=function(e){!function(e){"number"!=typeof e&&(e=.667);var t=document.createElement("canvas"),a=t.getContext("2d"),s=document.createElement("canvas"),i=s.getContext("2d");a.msImageSmoothingEnabled=!0,a.imageSmoothingEnabled=!0,i.msImageSmoothingEnabled=!0,i.imageSmoothingEnabled=!0,t.width=n.source.width,t.height=n.source.height,a.drawImage(n.source.image,0,0),n.output.original=t.toDataURL(n.output.type);for(var r=0;r<n.sizes.length;r++){s.width=t.width,s.height=t.height,i.drawImage(t,0,0);var o=s.width,d=n.sizes[r].width,l=Math.round(d/o*1e3)/1e3,g=s.height,m=Math.round(g*l);if(d>o)n.output[d]=null;else{for(;l<=e;){var u=Math.round(o*e),p=Math.round(g*e);t.width=u,t.height=p,a.drawImage(s,0,0,u,p),o=u,g=p,s.width=t.width,s.height=t.height,i.drawImage(t,0,0),l=Math.round(d/o*1e3)/1e3}t.width=d,t.height=m,a.drawImage(s,0,0,d,m),n.output[d]={},n.output[d].data=t.toDataURL(n.output.type),n.output[d].binary=n.output[d].data.split(",")[1]}}}()},this.getFilename=function(e){return this.output.name+e+"."+a[this.output.type]},this.printLinks=function(e){if(!(e instanceof HTMLElement||(e=document.getElementById(this.output.elementId))instanceof HTMLElement))throw"The argument must be an HTMLElement.";var t=document.createElement("div");$(t).addClass("card").html('<div class="card-header">'+this.output.fullname+"</div>");var a=document.createElement("ul");$(a).addClass("list-group");for(var s=0;s<this.sizes.length;s++){var i=this.sizes[s].width,n=this.sizes[s].suffix||"-x"+i,r=document.createElement("li");null===this.output[i]?$(r).attr("data-filename",this.getFilename(n)).addClass("list-group-item").addClass("disabled").html(this.getFilename(n)+'<span class="badge badge-warning">Source too small to scale to '+i+"px</span>"):$(r).attr("data-filename",this.getFilename(n)).addClass("list-group-item").html(this.getFilename(n)+'<span class="badge badge-light">Reduce width to '+i+"px</span>"),a.appendChild(r)}t.appendChild(a),e.appendChild(t)},this.getImages=function(){for(var e=[],t=0;t<this.sizes.length;t++){var a=this.sizes[t].width,s=this.sizes[t].suffix||"-x"+a;if(null!==this.output[a]){var i={};i.name=this.getFilename(s),i.data=this.output[a].data,i.binary=this.output[a].binary,e.push(i)}}return e}}$(document).ready(function(){function e(){var e=$("#images")[0].files;imagesSelected=e.length,imagesets=[],imagesLoaded=0,imagesProcessed=0,$("#output").empty(),$('#main button[type="submit"]').hide();var a=$("#preset-dropdown").val();if(imagesSelected&&""!=a)for(var s=savedPresets[a].sizes,i=0;i<imagesSelected;i++)!function(){var a=e[i],n={name:a.name.replace(/\.[^/.]+$/,""),fullname:a.name,elementId:"output",sizes:s},r=document.createElement("img");r.src=window.URL.createObjectURL(a),r.onload=function(){var e=new ImageSet(this,n);e.resize(),e.printLinks(),imagesets.push(e),imagesSelected==++imagesLoaded&&t().done(function(){$.each(existingImages,function(e,t){$('li[data-filename="'+t+'"]').addClass("disabled"),$('li[data-filename="'+t+'"] span').removeClass("badge-light").addClass("badge-warning").text("File already exists")}),$("#output li:not(.disabled)").length&&$('#main button[type="submit"]').prop("disabled",!1).show()})}}()}function t(){var e=gadget.apihost+"/files/list",t={site:gadget.site,authorization_token:gadget.token,path:gadget.getConfig("image_dir").replace(/\/?$/,"/")};return $.ajax({type:"GET",url:e,data:t,success:function(e){if(existingImages=[],e.staging_path!=t.path.replace(/\/$/,""))return $("#input-form").hide(),void messageUser(t.path+" does not exist. Update the gadget setting or create the folder first.");$("#input-form").show();for(var a=e.entries,s=0;s<a.length;s++)a[s].is_directory||existingImages.push(a[s].file_name)},error:function(e,t,a){messageUser("You don't have access to the upload folder! Contact your administrator.")}})}$("#user-message .close").on("click",function(){hideUserMessage()}),$("#images").change(e),$("#preset-dropdown").change(e),$('#main button[type="submit"]').on("click",function(e){if(e.preventDefault(),myGadget){$('#main button[type="submit"]').prop("disabled",!0);for(var t=0,a=0;a<imagesets.length;a++){var s=imagesets[a].getImages();t+=s.length}for(a=0;a<imagesets.length;a++){s=imagesets[a].getImages();for(var i=0;i<s.length;i++)!function(){var e=s[i],a=myGadget.getImageDir()+e.name;$('li[data-filename="'+e.name+'"]').is(".disabled")?++imagesProcessed==t&&finished():($('li[data-filename="'+e.name+'"] span').attr("class","badge badge-info").text("Uploading..."),myGadget.uploadImage(a,e.binary).done(function(s){$('li[data-filename="'+e.name+'"] span').attr("class","badge badge-primary").text("Publishing..."),myGadget.publishImage(a).done(function(a){$('li[data-filename="'+e.name+'"] span').attr("class","badge badge-success").text("Done"),++imagesProcessed==t&&finished()})}).fail(function(){messageUser("You don't have upload permissions. Contact your administrator.")}))}()}}}),gadget&&(document.getElementsByTagName("html")[0].classList.add("gadget"),gadget.ready().then(gadget.fetch).then(t).then(function(){var e;e={mime_type:metadata_mime_type},gadget.Metadata.list(e,{success:function(e){e.length&&(savedPresets=$.parseJSON(e[0].metadata)),gadget.admin?$("#input-form .input-group-append").show():$("#input-form .input-group-append").remove(),renderPresetDropdown()}});var t={settings:{site:gadget.site,authorization_token:gadget.token},getImageDir:function(){return gadget.getConfig("image_dir").replace(/\/?$/,"/")},getImageSizes:function(){try{return JSON.parse(gadget.getConfig("image_sizes"))}catch(e){}return null},getOverwrite:function(){return!1},uploadImage:function(e,t,a,s){var i=gadget.apihost+"/files/image_save",n={site:gadget.site,authorization_token:gadget.token,path:e,data:t,overwrite:a||this.getOverwrite()};return $.ajax({method:"post",url:i,data:n})},publishImage:function(e){var t=gadget.apihost+"/files/publish",a={site:gadget.site,authorization_token:gadget.token,path:e};return $.ajax({method:"post",url:t,data:a})}};window.myGadget=t}),$(gadget).on({expanded:function(e){},collapsed:function(e){},configuration:function(e,t){},notification:function(e,t){}}))}),Array.prototype.clone=function(){return this.slice(0)},$(function(){$("body").on("keyup","#manage-presets .form-group.row:last input",function(){$(this).closest(".form-group.row").find("input").filter(function(){return""==$(this).val()}).length||addPresetRow()}),$("body").on("change","#manage-presets :input",function(){$(this).valid()}),$("body").on("click","#manage-presets button.clear-row",function(){$(this).closest(".form-group").is(":last-of-type")?(1==$("#manage-presets .input-group").length?messageUser("You must keep at least one size!","warning",3e3):$(this).closest(".input-group").children(":text").filter(function(){return""!=$(this).val()}).length?messageUser("Cleared row. Empty rows will be ignored.","warning",3e3):messageUser("Empty rows will be ignored.","warning",3e3),$(this).closest(".input-group").children(":text").removeClass("invalid").val("")):$(this).closest(".form-group").remove()}),$("body").on("click","#list-card .list-group-item[data-preset-id]",function(e){loadPreset($(this).closest("[data-preset-id]").data("preset-id")),e.preventDefault()}),$("body").on("click","#list-card a.delete",function(e){deletePreset($(this).closest("[data-preset-id]").data("preset-id")),e.preventDefault(),e.stopPropagation()}),$("#list-card a.add-preset").on("click",function(e){loadPreset(),e.preventDefault()}),$("#manage-presets button.cancel").on("click",function(){switchDisplay("list-card")}),$("#list-card button.cancel").on("click",function(){switchDisplay("main")}),$("#manage-presets-btn").on("click",function(){presets=savedPresets.clone(),renderPresetList()}),$("#list-card button.save").on("click",savePresets),$("#manage-presets").on("submit",function(e){e.preventDefault();var t=[],a={},s={},i=trim($("#presetName").val()),n=trim($('#manage-presets [name="presetID"]').val()),r={},o=!0;if($.each(presets,function(e,t){r[t.name]=e.toString()}),""===i||i in r&&r[i]!==n?($("#presetName").invalid(),o=!1):$("#presetName").valid(),$("#manage-presets .form-group.row").each(function(){var e=$(this).find(".preset-width"),i=$(this).find(".preset-suffix"),n=e.val(),r=trim(i.val()),d=isInteger(n)&&!(n in a);a[n]=1;var l=!(""==r||r.toLowerCase()in s||/[!#$%^&*()[\]\\/?’”|<>{};:,+=]/.test(r));s[r.toLowerCase()]=1,d&&l?(e.valid(),i.valid(),t.push({width:n,suffix:r})):""==n&&""==r||(o=!1,d?e.valid():e.invalid(),l?i.valid():i.invalid())}),!t.length){var d=$("#manage-presets .preset-width:first"),l=$("#manage-presets .preset-suffix:first");isInteger(d.val())||d.invalid(),""==trim(l.val())&&l.invalid(),o=!1}o?(""===n?presets.push({name:i,sizes:t}):presets[n]={name:i,sizes:t},renderPresetList()):($("input.invalid:first").focus(),scrollToMiddle($("input.invalid:first")))})}),$.fn.invalid=function(){if(""==this.val())var e="This field is required!";else if(this.is(".preset-width")&&!isInteger(this.val()))e="Must be a positive integer!";else if(/[!#$%^&*()[\]\\/?’”|<>{};:,+=]/.test(this.val()))e="Cannot contain:\n!#$%^&*()[]/?’”|<>{};:,+=";else e="Must be unique!";return $(this).addClass("invalid").tooltip({title:e}),this},$.fn.valid=function(){return $(this).removeClass("invalid").tooltip("dispose"),this};